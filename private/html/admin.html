<!doctype html>
<html>
  <head>
    <title>Whiskers | Admin Panel</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="og:title" content="Whiskers | 404" />
    <meta name="og:description" content="Whiskers - Super Secret Messaging" />
    <meta name="og:image" content="/media/image/icons/logo.png" />
    <link rel="icon" type="image/png" href="/media/image/logo.png" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/settings.css" />
  </head>
  <body>
    <style>
      textarea {
        height: 100px;
        width: calc(100% - 10px);
        resize: none;
        padding: 5px;
        border-radius: 5px;
        background: var(--secondary);
        border: none;
        margin-bottom: 5px;
      }

      textarea.huge {
        height: 300px;
      }
    </style>
    <load>
      <img src="/media/image/icons/logo.png" />
    </load>
    <nav>
      <img
        width="30px"
        height="30px"
        class="user"
        onclick="goto('/pages/user')"
        src="/media/image/icons/profile.png"
      />
      <a id="home" href="/">
        <img class="logo" src="/media/image/icons/logo.png" />
        Whiskers
      </a>
      <img
        width="30px"
        height="30px"
        class="settings"
        onclick="goto('/pages/settings')"
        src="/media/image/icons/settings.png"
      />
    </nav>
    <div class="cards">
      <div class="chat-card">
        <div class="head">
          <h3 class="name">Accounts</h3>
        </div>
        <div class="body" id="accounts"></div>
        <div class="buttons">
          <div class="left">
            <button onclick="importData()">Import</button>
            <button onclick="exportData()">Export</button>
          </div>
          <div class="right">
            <button>Delete All</button>
          </div>
        </div>
      </div>
      <div class="chat-card">
        <div class="head">
          <h3 class="name">Evaluate JavaScript</h3>
        </div>
        <div class="body">
          <b>Input</b>
          <textarea
            autocorrect="false"
            autocapitalize="false"
            spellcheck="false"
            id="code"
          ></textarea>
          <b>Output</b>
          <textarea disabled id="console"></textarea>
        </div>
        <div class="buttons">
          <div class="left">
            <button onclick="clearConsole()">Clear</button>
          </div>
          <div class="right">
            <button onclick="runCode()">Run</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="/js/all.js"></script>
  <script>
    let longPress;
    const pw = params.get("pw");
    let gData;

    function runCode() {
      const code = document.getElementById("code").value;
      const console = document.getElementById("console");
      if (code == "") return (console.value += "No code to run\n");
      fetch("/admin/eval?pw=" + pw, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ code: code }),
      })
        .then((res) => res.json())
        .then((data) => {
          console.value += (data.result || "Nothing to log") + "\n";
          console.scrollTop = console.scrollHeight;
        });
    }

    function clearConsole() {
      document.getElementById("console").value = "";
    }

    fetch("/admin/accounts?pw=" + pw)
      .then((res) => res.json())
      .then((data) => {
        gData = data;
        const accounts = document.getElementById("accounts");
        const accKeys = Object.keys(data);
        accKeys.forEach((account) => {
          const option = document.createElement("div");
          option.classList.add("option");
          option.id = "acc" + account;
          option.innerHTML = `<span class="toggle" onclick="toggle('acc${account}')">${account}<img src="media/image/icons/down.png" id="acc${account}-toggle" class="arrow" /></span><div id="acc${account}-content" class="toggle-content"><textarea autocorrect="false" autocapitalize="false" class="huge" spellcheck="false">${JSON.stringify(data[account], null, 2)}</textarea></div>`;
          option.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            rcmenu(e, data, account);
          });
          accounts.appendChild(option);
        });
      });

    function toggle(id) {
      const content = document.getElementById(id + "-content");
      const toggle = document.getElementById(id + "-toggle");

      if (content.classList.contains("open")) {
        content.style.height = "0";
        toggle.style.transform = "rotate(0deg)";
        content.classList.remove("open");
      } else {
        const height = content.scrollHeight;
        content.style.height = height + "px";
        toggle.style.transform = "rotate(180deg)";
        content.classList.add("open");
      }
    }

    async function rcmenu(e, data, account) {
      const prevMenu = document.getElementById("rclickMenu");
      if (prevMenu) prevMenu.remove();
      const menu = document.createElement("div");
      menu.classList.add("rclick");
      menu.id = "rclickMenu";

      const copyMsg = document.createElement("div");
      copyMsg.classList.add("item");
      copyMsg.innerHTML = "Copy Data <img src='/media/image/icons/copy.png' />";
      copyMsg.onclick = () => {
        copyText(JSON.stringify(data[account], null, 2));
        if (document.querySelector("html.mobile")) {
          menu.style.bottom = "-100%";
        } else {
          menu.style.opacity = 0;
        }
        setTimeout(() => {
          menu.remove();
        }, 100);
      };
      menu.appendChild(copyMsg);

      const deleteMsg = document.createElement("div");
      deleteMsg.classList.add("item");
      deleteMsg.innerHTML =
        "Delete <img src='/media/image/icons/delete.png' />";
      deleteMsg.onclick = () => {
        deleteAcc(account);
        if (document.querySelector("html.mobile")) {
          menu.style.bottom = "-100%";
        } else {
          menu.style.opacity = 0;
        }
        setTimeout(() => {
          menu.remove();
        }, 100);
      };
      menu.appendChild(deleteMsg);

      if (!document.querySelector("html.mobile")) {
        menu.style.left = e.clientX + "px";
        menu.style.top = e.clientY + "px";
      }
      document.body.appendChild(menu);
      while (
        await new Promise((resolve) => setTimeout(() => resolve(longPress)))
      ) {}
      document.addEventListener("click", (e) => {
        if (document.querySelector("html.mobile")) {
          menu.style.bottom = "-100%";
        } else {
          menu.style.opacity = 0;
        }
        setTimeout(() => {
          menu.remove();
        }, 100);
        document.removeEventListener(e.type, arguments.callee);
      });
    }

    function deleteAcc(acc) {
      overlay(
        {
          type: "html",
          title: "Delete Account",
          body: `<p>Are you sure you want to delete <b>${acc}</b>?</p><button onclick="confDelete('${acc}'); closeOverlay('conf')">Confirm</button>`,
        },
        "conf",
      );
    }

    function confDelete(acc) {
      fetch("/admin/delete?pw=" + pw, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ user: acc }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            popup(data.error);
          } else {
            popup("Account deleted");
            window.location.reload();
          }
        });
    }

    function exportData() {
      download(JSON.stringify(gData, null, 2), "json", "whisker-users");
    }

    function importData() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = () => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            fetch("/admin/fullchange", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ json: data }),
            })
              .then((res) => {
                if (!res.ok) {
                  throw new Error(`HTTP error status: ${res.status}`);
                }
                return res.json();
              })
              .then((d) => {
                if (d.error) {
                  popup(d.error);
                } else {
                  popup("Data imported");
                  window.location.reload();
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                popup(error.message);
              });
          } catch (parseError) {
            console.error("JSON parse error:", parseError);
            popup("Invalid JSON format");
          }
        };
        reader.onerror = (e) => {
          console.error(e);
        };
      };
      input.click();
    }
  </script>
</html>
